#!/usr/bin/env php
<?php

declare(strict_types=1);

// -----------------------------------------------------------------------------
// CLI entrypoint for GoogleCalendarScheduler (V2)
// -----------------------------------------------------------------------------

use GoogleCalendarScheduler\Manifest\ManifestWriter;
use GoogleCalendarScheduler\Diff\Diff;
use GoogleCalendarScheduler\Intent\IntentNormalizer;
use GoogleCalendarScheduler\Intent\NormalizationContext;
use GoogleCalendarScheduler\Platform\FPPSemantics;
use GoogleCalendarScheduler\Platform\HolidayResolver;
use GoogleCalendarScheduler\Intent\CalendarRawEvent;
use GoogleCalendarScheduler\Adapter\CalendarSnapshot;
use GoogleCalendarScheduler\Adapter\CalendarTranslator;
use GoogleCalendarScheduler\Platform\IcsParser;

// -----------------------------------------------------------------------------
// Bootstrap
// -----------------------------------------------------------------------------

require_once __DIR__ . '/../bootstrap.php';

// -----------------------------------------------------------------------------
// Defaults
// -----------------------------------------------------------------------------

$DEFAULT_SCHEDULE_PATH =
    '/home/fpp/media/config/schedule.json';

$DEFAULT_MANIFEST_PATH =
    '/home/fpp/media/config/calendar-scheduler/manifest.json';

// -----------------------------------------------------------------------------
// Argument parsing
// -----------------------------------------------------------------------------

$opts = getopt('', [
    'dry-run',
    'schedule:',
    'manifest:',
    'format:',
    'quiet',
]);

$dryRun = array_key_exists('dry-run', $opts);
$quiet  = array_key_exists('quiet', $opts);

$schedulePath = $opts['schedule'] ?? $DEFAULT_SCHEDULE_PATH;
$manifestPath = $opts['manifest'] ?? $DEFAULT_MANIFEST_PATH;
$format       = $opts['format']   ?? 'text';

if (!in_array($format, ['text', 'json'], true)) {
    fwrite(STDERR, "ERROR: --format must be 'text' or 'json'\n");
    exit(64);
}

// -----------------------------------------------------------------------------
// Dependency construction
// -----------------------------------------------------------------------------

try {
    // -------------------------------------------------------------------------
    // Normalization context
    // -------------------------------------------------------------------------

    $env = json_decode(
        file_get_contents(__DIR__ . '/../runtime/fpp-env.json'),
        true,
        512,
        JSON_THROW_ON_ERROR
    );

    $tzName = $env['timezone']
        ?? $env['rawLocale']['timezone']
        ?? 'UTC';

    $context = new NormalizationContext(
        new DateTimeZone($tzName),
        new FPPSemantics(),
        new HolidayResolver($env['rawLocale']['holidays'])
    );

    $normalizer = new IntentNormalizer();

    // -------------------------------------------------------------------------
    // Load existing manifest (if any)
    // -------------------------------------------------------------------------

    $currentManifest = ['events' => []];
    if (file_exists($manifestPath)) {
        $currentManifest = json_decode(
            file_get_contents($manifestPath),
            true,
            512,
            JSON_THROW_ON_ERROR
        );
    }


    // -------------------------------------------------------------------------
    // Calendar → snapshot → intents (desired state)
    // -------------------------------------------------------------------------

    $parser = new IcsParser();
    $translator = new CalendarTranslator(
        $parser,
        '/home/fpp/media/config/calendar-scheduler/calendar/calendar-snapshot.json'
    );

    $snapshot = new CalendarSnapshot($translator);
    $calendarRaw = $snapshot->refreshFromIcs();
    $snapshot->write($calendarRaw);

    // Normalize calendar raw events into canonical Intent objects keyed by identityHash.
    $calendarIntents = [];
    foreach ($calendarRaw as $raw) {
        $intent = $normalizer->fromCalendar(
            CalendarRawEvent::fromArray($raw),
            $context
        );
        $calendarIntents[$intent->identityHash] = $intent;
    }

    // -------------------------------------------------------------------------
    // Build Next Manifest
    // -------------------------------------------------------------------------

    $writer = new ManifestWriter($manifestPath);
    $nextManifest = $writer->buildManifestFromIntents($calendarIntents);

    // -------------------------------------------------------------------------
    // Diff (manifest → manifest)
    // -------------------------------------------------------------------------

    $diff = new Diff();
    $diffPlan = $diff->diff(
        $nextManifest,
        $currentManifest
    );

    // -------------------------------------------------------------------------
    // Write manifest
    // -------------------------------------------------------------------------

    if (!$dryRun) {
        $writer->applyDiff(
            $currentManifest,
            $diffPlan,
            $calendarIntents
        );
    }


} catch (\GoogleCalendarScheduler\Core\IdentityInvariantViolation |
         \GoogleCalendarScheduler\Core\ManifestInvariantViolation $e) {

    fwrite(STDERR, "ERROR: {$e->getInvariantCode()}\n");
    fwrite(STDERR, $e->getMessage() . "\n");
    exit(1);

} catch (Throwable $e) {

    fwrite(STDERR, "ERROR: {$e->getMessage()}\n");
    exit(2);
}

// -----------------------------------------------------------------------------
// Output
// -----------------------------------------------------------------------------

$countCreate = $diffPlan->createCount();
$countUpdate = $diffPlan->updateCount();
$countDelete = $diffPlan->deleteCount();

if ($format === 'json') {
    echo json_encode([
        'noop'    => $countCreate === 0 && $countUpdate === 0 && $countDelete === 0,
        'created' => $countCreate,
        'updated' => $countUpdate,
        'deleted' => $countDelete,
        'dry_run' => $dryRun,
    ], JSON_PRETTY_PRINT) . "\n";
    exit(0);
}

// text output
if ($quiet) {
    exit(0);
}

if ($countCreate === 0 && $countUpdate === 0 && $countDelete === 0) {
    echo "Scheduler run complete.\n";
    echo "No changes required.\n";
    exit(0);
}

if ($dryRun) {
    echo "Dry run complete.\n";
    echo "Would create: {$countCreate}\n";
    echo "Would update: {$countUpdate}\n";
    echo "Would delete: {$countDelete}\n";
    exit(0);
}

echo "Scheduler run complete.\n";
echo "Created: {$countCreate}\n";
echo "Updated: {$countUpdate}\n";
echo "Deleted: {$countDelete}\n";
exit(0);